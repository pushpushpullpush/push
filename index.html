<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>push — Gallery Prototype</title>
  <style>
    :root{--gap:4px;--topbar:60px}
    body{
      margin:0;
      background:#fff;
      font-family:Helvetica,Arial,sans-serif;
      overflow-x:hidden;
    }

    /* LANDING OVERLAY */
    #landingOverlay{
      position:fixed;
      inset:0;
      background:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:250;
      opacity:1;
      transition:opacity 0.25s ease-out;
    }
    #landingOverlay.hidden{
      opacity:0;
      pointer-events:none;
    }
    #landingLogo{
      font-family:Helvetica,Arial,sans-serif;
      font-size:20px;
      cursor:pointer;
    }
    #landingMessage{
      margin-top:12px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:12px;
      color:#777;
      opacity:0;
      transition:opacity 0.15s ease-out;
    }
    #landingContact{
      position:absolute;
      bottom:40px;
      left:50%;
      transform:translateX(-50%);
      font-family:Helvetica,Arial,sans-serif;
      font-size:11px;
      color:#ccc;
      letter-spacing:0.02em;
      cursor:pointer;
    }

    /* CONTACT OVERLAY (minimal) */
    #contactOverlay{
      position:fixed;
      inset:0;
      background:#ffffff;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:260;
    }
    #contactBox{
      position:relative;
      padding:18px 22px;
      border:1px solid #eee;
      border-radius:12px;
      min-width:220px;
      text-align:center;
    }
    #contactTitle{
      font-family:Helvetica,Arial,sans-serif;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:lowercase;
      color:#444;
    }
    #contactSub{
      margin-top:8px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:11px;
      color:#bbb;
    }
    #contactClose{
      position:absolute;
      top:8px;
      right:10px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      color:#999;
      cursor:pointer;
    }
    #contactClose:hover{
      color:#666;
    }

    /* AUTH OVERLAY */
    #authOverlay{
      position:fixed;
      inset:0;
      background:#ffffffee;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:270;
    }
    #authBox{
      position:relative;
      padding:18px 22px;
      border:1px solid #eee;
      border-radius:12px;
      min-width:220px;
      text-align:left;
      background:#fff;
    }
    #authBox input{
      border:none;
      border-bottom:1px solid #ddd;
      font-family:Helvetica,Arial,sans-serif;
      font-size:13px;
      padding:4px 0;
      outline:none;
      width:180px;
      background:transparent;
      display:block;
    }
    #authBox input + input{
      margin-top:10px;
    }
    #authHint{
      margin-top:10px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:10px;
      color:#aaa;
      max-width:220px;
      line-height:1.4;
    }
    #authEnter{
      margin-top:14px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:13px;
      cursor:pointer;
      color:#444;
    }
    #authCancel{
      position:absolute;
      top:6px;
      right:8px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      color:#999;
      cursor:pointer;
    }
    #authCancel:hover{
      color:#666;
    }

    /* TOP BAR */
    #topBar{
      position:fixed;
      top:0;left:0;right:0;
      height:var(--topbar);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      box-sizing:border-box;
      z-index:100;
      background:#ffffffcc;
      backdrop-filter:blur(6px);
      border-bottom:1px solid #eee;
    }
    #logo{
      font-size:20px;
      cursor:pointer;
    }

    /* zentrierte Blöcke zwischen push & pull */
    #leftCenter,
    #rightCenter{
      display:flex;
      align-items:center;
    }
    #leftCenter{
      margin-left:32px;
    }
    #rightCenter{
      margin-right:32px;
    }

    /* Suche */
    #searchInput{
      margin-left:0;
      padding:0;
      border:none;
      background:transparent;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      outline:none;
      width:70px;
      color:#222;
      cursor:text;
    }
    #searchInput::placeholder{
      color:#555;
      opacity:1;
    }
    #searchLabel{
      margin-left:8px;
      font-size:11px;
      color:#999;
      font-family:Helvetica,Arial,sans-serif;
      cursor:pointer;
      display:none;
    }

    #profileBtn{
      cursor:pointer;
      font-size:20px;
      color:#222;
      font-weight:400;
      font-family:Helvetica,Arial,sans-serif;
    }

    /* Slider */
    #columnsRange{
      width:120px;
      appearance:none;
      background:transparent;
      height:14px;
      border-radius:2px;
    }
    #columnsRange:focus{ outline:none; }
    #columnsRange::-webkit-slider-runnable-track{
      height:14px;
      background:transparent;
      border-radius:2px;
    }
    #columnsRange::-moz-range-track{
      height:14px;
      background:transparent;
      border-radius:2px;
    }
    #columnsRange::-webkit-slider-thumb{
      appearance:none;
      width:0;
      height:0;
      border:none;
      background:transparent;
      margin-top:0;
    }
    #columnsRange::-moz-range-thumb{
      width:0;
      height:0;
      border:none;
      background:transparent;
    }

    /* gallery grid */
    #gallery{
      margin-top:calc(var(--topbar) + 10px);
      display:grid;
      gap:var(--gap);
      padding:var(--gap);
      box-sizing:border-box;
    }
    .thumb{
      width:100%;
      display:block;
      cursor:pointer;
      object-fit:cover;
    }

    /* Hero: halb breit, rechtsbündig */
    .heroWrap{
      grid-column:1 / -1;
      display:flex;
      justify-content:flex-end;
    }
    .heroThumb{
      width:50%;
      max-width:50%;
      display:block;
      object-fit:cover;
    }

    /* Empty state */
    .emptyState{
      grid-column:1 / -1;
      padding:40px 0 80px;
      text-align:center;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      color:#aaa;
    }

    /* Username-/Wall-Bar */
    #leaveBar{
      display:none;
      grid-column:1 / -1;
      padding:80px 18px;
      background:#fff;
      box-sizing:border-box;
    }
    #leaveMainRow{
      display:flex;
      align-items:center;
      gap:32px;
      flex-wrap:wrap;
    }
    #leaveOwner{
      font-family:Helvetica,Arial,sans-serif;
      font-size:20px;
      color:#222;
      cursor:pointer;
    }
    #leaveInfluences{
      display:flex;
      align-items:center;
      gap:24px;
      margin-left:16px;
      flex-wrap:wrap;
    }
    #leaveInfluences span{
      font-family:Helvetica,Arial,sans-serif;
      font-size:20px;
      color:#bbb;
      cursor:pointer;
    }
    #leaveInfluences span:hover{
      color:#444;
    }
    #leaveLogout{
      margin-top:12px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      text-align:right;
      color:#444;
      cursor:pointer;
      display:none;
    }

    /* single scroll view */
    #singleScrollView{
      position:fixed;
      inset:0;
      background:#fff;
      overflow-y:scroll;
      display:none;
      z-index:80;
      padding-top:var(--topbar);
      opacity:0;
      transition:opacity 0.12s ease-out;
    }
    .singleItem{
      height:calc(100vh - var(--topbar));
      display:flex;
      align-items:center;
      justify-content:center;
      padding-top:24px;
      padding-bottom:120px;
      box-sizing:border-box;
      position:relative;
      flex-direction:column;
    }
    .singleItem img{
      max-height:calc(100vh - var(--topbar) - 24px - 120px);
      max-width:90vw;
      object-fit:contain;
      cursor:pointer;
    }
    .singleItem img.hiddenAdmin{
      outline:1px solid #f3cccc;
    }
    .actionBtn{
      position:absolute;
      right:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      cursor:pointer;
      color:#555;
    }

    /* report */
    .reportBtn{
      position:absolute;
      left:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      cursor:pointer;
      color:#aaa;
    }
    .reportBtn.reported{
      color:#c33;
    }
    .restoreBtn{
      position:absolute;
      left:5vw;
      bottom:62px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:12px;
      cursor:pointer;
      color:#777;
    }

    /* Hover-Zone links (puller) */
    .hoverLeft{
      position:absolute;
      top:0;
      bottom:80px;
      left:5vw;
      width:12vw;
      cursor:default;
    }
    .singleUsers{
      position:absolute;
      left:5vw;
      top:50%;
      transform:translateY(-50%);
      font-family:Helvetica,Arial,sans-serif;
      font-size:13px;
      color:#bbb;
      max-width:12vw;
      max-height:60vh;
      line-height:1.4;
      text-align:left;
      white-space:pre-line;
      display:none;
      overflow-y:auto;
    }
    .singleUsers div{
      cursor:pointer;
    }
    .singleUsers div:hover{
      color:#888;
    }
    .hoverLeft:hover + .singleUsers{
      display:block;
    }

    /* upload overlay */
    #uploadOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:#fff;
      z-index:200;
      flex-direction:column;
    }
    #uploadPreview{
      max-width:50vw;
      max-height:50vh;
      object-fit:contain;
      margin-bottom:18px;
    }
    .uploadMeta{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
      color:#444;
      align-items:flex-start;
    }
    .uploadMeta input{
      border:none;
      border-bottom:1px solid #ddd;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      padding:2px 0;
      outline:none;
      width:260px;
      background:transparent;
    }
    #tagInput::placeholder{
      color:#555;
      opacity:1;
    }
    .tagChips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .tagChip{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      font-family:Helvetica,Arial,sans-serif;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .tagChip:hover{
      border-color:#aaa;
      background:#f5f5f5;
    }

    #uploadHint{
      position:absolute;
      right:5vw;
      bottom:72px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:11px;
      color:#999;
      max-width:260px;
      line-height:1.4;
      display:none;
    }
    #uploadPush{
      position:absolute;
      right:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      color:#444;
      cursor:pointer;
    }
    #uploadCancel{
      position:absolute;
      left:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      color:#444;
      cursor:pointer;
    }

    .hideRange #columnsRange{display:none}

    /* Drag & Drop Overlay */
    #dropZone{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      border:4px dashed #bbb;
      background:rgba(0,0,0,0.04);
      z-index:190;
      font-size:22px;
      color:#666;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <!-- LANDING PAGE -->
  <div id="landingOverlay">
    <div id="landingLogo">push</div>
    <div id="landingMessage">All images published will be online forever.</div>
    <div id="landingContact">contact</div>
  </div>

  <!-- CONTACT OVERLAY -->
  <div id="contactOverlay">
    <div id="contactBox">
      <div id="contactTitle">contact</div>
      <div id="contactSub">form coming soon</div>
      <div id="contactClose">✕</div>
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay">
    <div id="authBox">
      <input id="authName" type="text" placeholder="name" autocomplete="username" />
      <input id="authKey" type="password" placeholder="key" autocomplete="current-password" />
      <div id="authHint">name + key keep your pulls across browsers. keep them simple.</div>
      <div id="authEnter">enter</div>
      <div id="authCancel">✕</div>
    </div>
  </div>

  <div id="topBar">
    <div id="logo">push</div>

    <div id="leftCenter">
      <input id="searchInput" type="text" placeholder="search" />
      <span id="searchLabel"></span>
    </div>

    <div id="rightCenter">
      <input id="columnsRange" type="range" min="2" max="7" value="5" />
    </div>

    <div id="profileBtn">pull</div>
  </div>

  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div id="dropZone">drop image here</div>

  <div id="gallery"></div>

  <div id="leaveBar">
    <div id="leaveMainRow">
      <span id="leaveOwner"></span>
      <span id="leaveInfluences"></span>
    </div>
    <div id="leaveLogout">logout</div>
  </div>

  <div id="singleScrollView"></div>

  <div id="uploadOverlay">
    <img id="uploadPreview" alt="preview" />
    <div class="uploadMeta">
      <input id="tagInput" type="text" placeholder="tags" />
      <div id="tagChips" class="tagChips"></div>
    </div>
    <div id="uploadHint">
      I understand the image will be published forever and cannot be deleted.
      I own the rights of this image.
    </div>
    <div id="uploadPush">push</div>
    <div id="uploadCancel">✕</div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase Setup ===
    const { createClient } = supabase;

    const SUPABASE_URL    = 'https://wsftiujnfywdxmzrvgqv.supabase.co';   // HIER dein Projekt-URL
    const SUPABASE_KEY    = 'sb_publishable_o1e3kkJkw4ofmi_lFI0Q8g_Mr0GL_k8';    // HIER dein anon/publishable Key
    const SUPABASE_BUCKET = 'images';                            // Storage-Bucket
    const SUPABASE_TABLE  = 'images';                            // Bild-Metadaten
    const SUPABASE_PULLS_TABLE = 'pulls';                        // Pulls-Tabelle

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    function dataURLToBlob(dataURL){
      const parts = dataURL.split(',');
      const mimeMatch = parts[0].match(/:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/jpeg';
      const binary = atob(parts[1]);
      const len = binary.length;
      const u8 = new Uint8Array(len);
      for(let i=0;i<len;i++){
        u8[i] = binary.charCodeAt(i);
      }
      return new Blob([u8], { type: mime });
    }

    const REPORT_THRESHOLD = 5;

    // Demo-Fallback-Bilder (falls DB leer ist)
    let images = [
      {
        id: null,
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#111'/><circle cx='400' cy='300' r='160' fill='#444'/><text x='50%' y='50%' fill='#fafafa' font-size='36' font-family='Helvetica' text-anchor='middle' dy='12'>luna 01</text></svg>",
        tags: ["luna","demo","dark"],
        pullers: ["luna"],
        reportBy: [],
        reportHidden: false
      },
      {
        id: null,
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#f5f5f5'/><rect x='80' y='60' width='640' height='480' fill='#ddd'/><text x='50%' y='50%' fill='#444' font-size='32' font-family='Helvetica' text-anchor='middle' dy='10'>ghost 01</text></svg>",
        tags: ["ghost","demo","gray"],
        pullers: ["ghost"],
        reportBy: [],
        reportHidden: false
      },
      {
        id: null,
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#002b36'/><rect x='120' y='120' width='560' height='360' fill='#268bd2'/><text x='50%' y='50%' fill='#fdf6e3' font-size='30' font-family='Helvetica' text-anchor='middle' dy='10'>luna & ghost</text></svg>",
        tags: ["luna","ghost","demo"],
        pullers: ["luna","ghost"],
        reportBy: [],
        reportHidden: false
      }
    ];

    let saved  = [];             // Pulls der aktuellen Session / Users
    let pendingImage = null;
    let pendingTags = [];
    let area = 'public';         // 'public' | 'private'
    let viewOwner = null;        // null oder username, wenn auf fremder Wall
    let uploadConfirmStep = 0;
    let searchTerm = '';

    let currentSingleList = null;
    let currentSingleIndex = null;

    let currentUser = null;      // { username, userId, wallPulls }
    let authUser = null;         // Supabase user object
    let ownerMenuOpen = false;

    const scrollState = {
      public: 0,
      private: 0,
      walls: {}
    };

    // Map: username -> array von usernames, die er als Wall gepullt hat
    let wallPullsByUser = {};
    try{
      wallPullsByUser = JSON.parse(localStorage.getItem('push_wall_pulls') || '{}');
    }catch(e){
      wallPullsByUser = {};
    }
    function saveWallPulls(){
      try{
        localStorage.setItem('push_wall_pulls', JSON.stringify(wallPullsByUser));
      }catch(e){}
    }

    const gallery           = document.getElementById('gallery');
    const singleScrollView  = document.getElementById('singleScrollView');
    const columnsRange      = document.getElementById('columnsRange');
    const profileBtn        = document.getElementById('profileBtn');
    const logo              = document.getElementById('logo');
    const uploadOverlay     = document.getElementById('uploadOverlay');
    const uploadPreview     = document.getElementById('uploadPreview');
    const uploadPush        = document.getElementById('uploadPush');
    const uploadCancel      = document.getElementById('uploadCancel');
    const fileInput         = document.getElementById('fileInput');
    const searchInput       = document.getElementById('searchInput');
    const searchLabel       = document.getElementById('searchLabel');
    const leaveBar          = document.getElementById('leaveBar');
    const leaveOwner        = document.getElementById('leaveOwner');
    const leaveInfluences   = document.getElementById('leaveInfluences');
    const leaveLogout       = document.getElementById('leaveLogout');
    const dropZone          = document.getElementById('dropZone');

    const tagInput          = document.getElementById('tagInput');
    const tagChips          = document.getElementById('tagChips');
    const uploadHint        = document.getElementById('uploadHint');

    const landingOverlay    = document.getElementById('landingOverlay');
    const landingLogo       = document.getElementById('landingLogo');
    const landingMessage    = document.getElementById('landingMessage');
    const landingContact    = document.getElementById('landingContact');

    const contactOverlay    = document.getElementById('contactOverlay');
    const contactClose      = document.getElementById('contactClose');

    const authOverlay       = document.getElementById('authOverlay');
    const authName          = document.getElementById('authName');
    const authKey           = document.getElementById('authKey');
    const authEnter         = document.getElementById('authEnter');
    const authCancel        = document.getElementById('authCancel');

    let authResolve = null;
    let authInProgress = false;

    const isSaved = src => saved.some(s => s.src === src);

    function isAdmin(){
      return currentUser && currentUser.username === 'push-admin';
    }

    function saveCurrentUser(){
      // Supabase Auth hält die Session; hier müssen wir nichts extra tun
    }

    function parseTagsInput(raw){
      if(!raw) return [];
      return raw
        .split(/[, \t]+/)
        .map(t => t.trim().toLowerCase())
        .filter(t => t.length > 0 && t.length <= 21 && /^[a-z0-9]+$/.test(t));
    }

    function renderTagChips(){
      tagChips.innerHTML = '';
      pendingTags.forEach((t, i) => {
        const chip = document.createElement('div');
        chip.className = 'tagChip';
        chip.textContent = t;
        chip.onclick = () => {
          pendingTags.splice(i, 1);
          renderTagChips();
        };
        tagChips.appendChild(chip);
      });
    }

    tagInput.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ' || e.key === ',' || e.key === 'Tab'){
        const raw = tagInput.value;
        if(!raw.trim() && e.key === 'Tab'){
          return;
        }
        e.preventDefault();
        const list = parseTagsInput(raw);
        list.forEach(tag => {
          if(pendingTags.length < 7 && !pendingTags.includes(tag)){
            pendingTags.push(tag);
          }
        });
        tagInput.value = '';
        renderTagChips();
      }
    });

    function matchesSearch(img){
      if(!searchTerm) return true;

      const raw = searchTerm.trim();

      if(raw.startsWith('#')){
        const q = raw.slice(1).toLowerCase().trim();
        if(!q) return true;
        const tagsArr = img.tags || [];
        return tagsArr.some(t => (t || '').toLowerCase().includes(q));
      }

      const q       = raw.toLowerCase();
      const tagsStr = (img.tags || []).join(' ').toLowerCase();
      const pullers = (img.pullers || []).join(' ').toLowerCase();

      return (
        tagsStr.includes(q) ||
        pullers.includes(q)
      );
    }

    function findUserByQuery(qRaw){
      const q = (qRaw || '').trim().toLowerCase();
      if(!q) return null;

      const found = new Set();

      images.forEach(img => {
        (img.pullers || []).forEach(u => {
          if(u && u.toLowerCase() === q){
            found.add(u);
          }
        });
      });

      Object.keys(wallPullsByUser || {}).forEach(owner=>{
        if(owner && owner.toLowerCase() === q){
          found.add(owner);
        }
      });

      if(currentUser && currentUser.username &&
         currentUser.username.toLowerCase() === q){
        found.add(currentUser.username);
      }

      if(found.size === 0) return null;
      return [...found][0];
    }

    function getAllWallOwners(){
      const set = new Set();

      images.forEach(img => {
        (img.pullers || []).forEach(u => {
          if(u) set.add(u);
        });
      });

      Object.keys(wallPullsByUser || {}).forEach(owner=>{
        if(owner) set.add(owner);
        (wallPullsByUser[owner] || []).forEach(u=>{
          if(u) set.add(u);
        });
      });

      if(currentUser && currentUser.username){
        set.add(currentUser.username);
      }
      if(viewOwner){
        set.add(viewOwner);
      }

      return [...set];
    }

    function isHiddenGlobal(img){
      if(isAdmin()) return false;
      const base = images.find(i => i.src === img.src);
      return !!(base && base.reportHidden);
    }

    function updateHiddenFlag(base){
      const count = (base.reportBy || []).length;
      base.reportHidden = count >= REPORT_THRESHOLD;
    }

    function updateColumns(){
      const v = Number(columnsRange.value);
      const cols = 9 - v;
      gallery.style.gridTemplateColumns = `repeat(${cols},1fr)`;

      const min = Number(columnsRange.min);
      const max = Number(columnsRange.max);
      const ratio = (v - min) / (max - min || 1);
      const pct = ratio * 100;

      const grad = `linear-gradient(to right,#555 0%,#555 ${pct}%,#ddd ${pct}%,#ddd 100%)`;
      columnsRange.style.background = grad;
      columnsRange.style.backgroundSize = '100% 2px';
      columnsRange.style.backgroundPosition = 'center';
      columnsRange.style.backgroundRepeat = 'no-repeat';
    }
    columnsRange.addEventListener('input', updateColumns);
    updateColumns();

    function blinkWord(el){
      el.style.opacity = '0';
      setTimeout(() => {
        el.style.opacity = '1';
      }, 120);
    }

    function updateSearchLabel(){
      if(searchTerm){
        searchLabel.style.display = 'inline';
        searchLabel.textContent = '✕';
      } else {
        searchLabel.style.display = 'none';
        searchLabel.textContent = '';
      }
    }

    function setGridUIVisible(on){
      if(on){
        columnsRange.style.display = 'block';
        searchInput.style.display  = 'inline';
        updateSearchLabel();
      }else{
        columnsRange.style.display = 'none';
        searchInput.style.display  = 'none';
        searchLabel.style.display  = 'none';
      }
    }

    function getCurrentList(){
      const q = (searchTerm || '').toLowerCase();

      if(isAdmin() && q){
        if(q === 'reported'){
          return images.filter(img => (img.reportBy || []).length > 0);
        }
        if(q === 'hidden'){
          return images.filter(img => img.reportHidden);
        }
      }

      if(!viewOwner && area === 'private'){
        const res = [];
        for(const s of saved){
          const base = images.find(img => img.src === s.src);
          if(base && !isHiddenGlobal(base)){
            res.push(base);
          }
        }
        return res;
      }

      let base;
      if(viewOwner){
        base = images.filter(img => img.pullers && img.pullers.includes(viewOwner));
      } else {
        base = images;
      }
      return base.filter(img => !isHiddenGlobal(img));
    }

    function renderGallery(){
      gallery.innerHTML = '';
      leaveInfluences.innerHTML = '';

      const baseList = getCurrentList();
      const q = (searchTerm || '').toLowerCase();
      let list;
      if(isAdmin() && (q === 'reported' || q === 'hidden')){
        list = baseList;
      } else {
        list = baseList.filter(matchesSearch);
      }

      const isOwnPullGallery      = (!viewOwner && area === 'private' && currentUser);
      const isForeignPullGallery  = !!viewOwner;
      const isPullGallery         = isOwnPullGallery || isForeignPullGallery;

      if(!isPullGallery){
        ownerMenuOpen = false;
        leaveBar.style.display = 'none';
        leaveLogout.style.display = 'none';
        leaveInfluences.style.display = 'none';

        if(list.length === 0){
          const msg = document.createElement('div');
          msg.className = 'emptyState';
          msg.textContent = 'no images';
          gallery.appendChild(msg);
          return;
        }

        list.forEach((img, i) => {
          const el = document.createElement('img');
          el.src = img.src;
          el.className = 'thumb';
          el.onclick = () => openSingle(i, list);
          gallery.appendChild(el);
        });
        return;
      }

      // Pull-Galerien
      leaveBar.style.display = 'block';

      if(isOwnPullGallery){
        leaveOwner.textContent = currentUser.username;

        const ownPulls = wallPullsByUser[currentUser.username] || [];
        ownPulls.forEach(un => {
          const s = document.createElement('span');
          s.textContent = un;
          s.onclick = ev => {
            ev.stopPropagation();
            openUserWall(un);
          };
          leaveInfluences.appendChild(s);
        });

        if(ownerMenuOpen){
          leaveInfluences.style.display = 'none';
          leaveLogout.style.display = 'block';
        } else {
          leaveLogout.style.display = 'none';
        }

        leaveOwner.onclick = ev => {
          ev.stopPropagation();
          ownerMenuOpen = !ownerMenuOpen;
          renderGallery();
        };

      } else {
        ownerMenuOpen = false;

        leaveOwner.textContent = viewOwner;
        leaveLogout.style.display = 'none';

        const foreignPulls = wallPullsByUser[viewOwner] || [];
        foreignPulls.forEach(un => {
          const s = document.createElement('span');
          s.textContent = un;
          s.onclick = ev => {
            ev.stopPropagation();
            openUserWall(un);
          };
          leaveInfluences.appendChild(s);
        });

        leaveOwner.onclick = async ev => {
          ev.stopPropagation();
          const ok = await ensureAuth();
          if(!ok) return;
          const uName = viewOwner;
          if(!wallPullsByUser[currentUser.username]){
            wallPullsByUser[currentUser.username] = [];
          }
          const pulls = wallPullsByUser[currentUser.username];
          const idx = pulls.indexOf(uName);
          let flash = '';

          if(idx === -1){
            if(pulls.length >= 7){
              pulls.shift();
            }
            pulls.push(uName);
            flash = 'pull';
          } else {
            pulls.splice(idx,1);
            flash = 'push';
          }
          currentUser.wallPulls = pulls;
          saveWallPulls();

          const original = leaveOwner.textContent;
          leaveOwner.textContent = flash;
          setTimeout(() => {
            leaveOwner.textContent = original;
          }, 220);
        };
      }

      const allOwners = getAllWallOwners();
      if(allOwners.length){
        const pushSpan = document.createElement('span');
        pushSpan.textContent = 'push';
        pushSpan.onclick = (e) => {
          e.stopPropagation();

          let candidates = allOwners;

          if(viewOwner){
            candidates = allOwners.filter(u => u !== viewOwner);
            if(!candidates.length) candidates = allOwners;
          } else if(currentUser && isOwnPullGallery){
            candidates = allOwners.filter(u => u !== currentUser.username);
            if(!candidates.length) candidates = allOwners;
          }

          const idx = Math.floor(Math.random()*candidates.length);
          const target = candidates[idx];
          if(target){
            blinkWord(pushSpan);
            openUserWall(target);
          }
        };
        leaveInfluences.appendChild(pushSpan);
      }

      if(ownerMenuOpen){
        leaveInfluences.style.display = 'none';
      } else {
        leaveInfluences.style.display =
          leaveInfluences.children.length ? 'flex' : 'none';
      }

      if(list.length === 0){
        const msg = document.createElement('div');
        msg.className = 'emptyState';
        msg.textContent = isOwnPullGallery ? 'no pulls yet' : 'no images';
        gallery.appendChild(msg);
        gallery.appendChild(leaveBar);
        return;
      }

      const heroWrap = document.createElement('div');
      heroWrap.className = 'heroWrap';

      const heroImg = document.createElement('img');
      heroImg.src = list[0].src;
      heroImg.className = 'thumb heroThumb';
      heroImg.onclick = () => openSingle(0, list);

      heroWrap.appendChild(heroImg);
      gallery.appendChild(heroWrap);

      gallery.appendChild(leaveBar);

      for(let i = 1; i < list.length; i++){
        const el = document.createElement('img');
        el.src = list[i].src;
        el.className = 'thumb';
        el.onclick = () => openSingle(i, list);
        gallery.appendChild(el);
      }
    }

    function closeScroll(src){
      singleScrollView.style.display = 'none';
      singleScrollView.style.opacity = 0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      if(src){
        const t = [...gallery.querySelectorAll('img')].find(x => x.src === src);
        if(t) t.scrollIntoView({ behavior: 'auto', block: 'nearest' });
      }
      currentSingleList = null;
      currentSingleIndex = null;
    }

    function openUserWall(username){
      viewOwner = username;
      area = 'public';
      singleScrollView.style.display = 'none';
      singleScrollView.style.opacity = 0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      const y = scrollState.walls[username] || 0;
      window.scrollTo({ top: y, behavior: 'auto' });
    }

    function openSingle(startIndex, listOverride=null){
      setGridUIVisible(false);

      const fullList = getCurrentList();
      const q = (searchTerm || '').toLowerCase();
      const list = listOverride || (
        (isAdmin() && (q === 'reported' || q === 'hidden'))
          ? fullList
          : fullList.filter(matchesSearch)
      );
      singleScrollView.innerHTML='';

      currentSingleList = list;
      currentSingleIndex = startIndex;

      const effectiveArea = viewOwner ? 'public' : area;
      const reporterId = (currentUser && currentUser.username) || '__anon__';

      function updateActions(){
        singleScrollView.querySelectorAll('.actionBtn').forEach((btn,i)=>{
          const item=list[i]; if(!item) return;
          btn.textContent = (effectiveArea==='public')
            ? (isSaved(item.src) ? 'push' : 'pull')
            : 'push';
        });
      }

      list.forEach((img,idx)=>{
        const wrap=document.createElement('div');
        wrap.className='singleItem';

        const base = images.find(i => i.src === img.src) || img;
        if(!base.reportBy) base.reportBy = [];

        const im=document.createElement('img');
        im.src=img.src;
        if(isAdmin() && base.reportHidden){
          im.classList.add('hiddenAdmin');
        }
        im.onclick=()=>closeScroll(img.src);
        wrap.appendChild(im);

        const rep = document.createElement('div');
        rep.className = 'reportBtn';
        rep.textContent = 'report';
        if(base.reportBy.includes(reporterId)) rep.classList.add('reported');
        rep.onclick = e => {
          e.stopPropagation();
          if(!base.reportBy) base.reportBy = [];
          const already = base.reportBy.includes(reporterId);
          if(!already){
            base.reportBy.push(reporterId);
          } else {
            base.reportBy = base.reportBy.filter(id => id !== reporterId);
          }
          updateHiddenFlag(base);
          const nowReported = base.reportBy.includes(reporterId);
          rep.classList.toggle('reported', nowReported);
          rep.textContent = nowReported ? 'reported' : 'undo';
          setTimeout(() => { rep.textContent = 'report'; }, 800);
          renderGallery();
        };
        wrap.appendChild(rep);

        if(isAdmin() && base.reportBy.length > 0){
          const restore = document.createElement('div');
          restore.className = 'restoreBtn';
          restore.textContent = base.reportHidden ? 'restore · hidden' : 'restore';
          restore.onclick = e => {
            e.stopPropagation();
            base.reportBy = [];
            base.reportHidden = false;
            rep.classList.remove('reported');
            rep.textContent = 'report';
            renderGallery();
          };
          wrap.appendChild(restore);
        }

        const hoverLeft = document.createElement('div');
        hoverLeft.className = 'hoverLeft';
        wrap.appendChild(hoverLeft);

        const usersDiv = document.createElement('div');
        usersDiv.className = 'singleUsers';
        function renderUsersList(){
          usersDiv.innerHTML = '';
          if(base.pullers && base.pullers.length){
            base.pullers.forEach(name=>{
              const line = document.createElement('div');
              line.textContent = name;
              line.onclick = ev => {
                ev.stopPropagation();
                openUserWall(name);
              };
              usersDiv.appendChild(line);
            });
          }
        }
        renderUsersList();
        wrap.appendChild(usersDiv);

        const act=document.createElement('div');
        act.className='actionBtn';
        act.textContent = (effectiveArea==='public')
          ? (isSaved(img.src) ? 'push' : 'pull')
          : 'push';
        act.onclick = async e=>{
          e.stopPropagation();
          if(effectiveArea==='public'){
            const wasSaved = isSaved(base.src);
            const ok = await ensureAuth();
            if(!ok) return;
            const shouldPull = !wasSaved;
            await setPullForImage(base, shouldPull);
            updateActions();
            renderUsersList();
          } else {
            const iSaved = saved.findIndex(s=>s.src===base.src);
            if(iSaved!==-1){
              const removed = saved[iSaved];
              const pub = images.find(x=>x.src===removed.src) || base;
              await setPullForImage(pub, false);
              if(saved.length===0){
                closeScroll(null);
              } else {
                openSingle(Math.min(iSaved,saved.length-1));
              }
            }
          }
        };
        wrap.appendChild(act);

        singleScrollView.appendChild(wrap);
      });

      singleScrollView.style.display='block';
      requestAnimationFrame(()=>{
        singleScrollView.style.opacity = 1;
      });
      document.body.classList.add('hideRange');
      const target = singleScrollView.children[startIndex];
      if (target) target.scrollIntoView({ behavior: 'auto', block: 'center' });
    }

    function updateProfile(){
      profileBtn.textContent = 'pull';
    }

    profileBtn.onclick = async () => {
      blinkWord(profileBtn);
      const ok = await ensureAuth();
      if(!ok) return;
      area = 'private';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      const y = scrollState.private || 0;
      window.scrollTo({ top: y, behavior: 'auto' });
    };

    async function doLogout(){
      if(!currentUser && !authUser) return;
      try{
        await supabaseClient.auth.signOut();
      }catch(e){}
      authUser = null;
      currentUser = null;
      saved = [];
      try{
        localStorage.removeItem('push_user');
        localStorage.removeItem('push_saved');
      }catch(e){}
      area = 'public';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      updateProfile();
      window.scrollTo({ top: 0, behavior: 'auto' });
    }

    leaveLogout.onclick = () => {
      if(confirm('logout?')){
        doLogout();
        leaveLogout.style.display = 'none';
      }
    };

    logo.onclick = () => {
      blinkWord(logo);
      area = 'public';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      scrollState.public = 0;
      window.scrollTo({ top: 0, behavior:'auto' });
    };

    searchInput.addEventListener('input', e => {
      searchTerm = e.target.value.trim();
      updateSearchLabel();
      renderGallery();
    });

    searchInput.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        const raw = searchInput.value.trim();
        if(!raw) return;
        if(raw.startsWith('#')) return;

        const userName = findUserByQuery(raw);
        if(userName){
          searchTerm = '';
          searchInput.value = '';
          updateSearchLabel();
          openUserWall(userName);
          e.preventDefault();
        }
      }
    });

    searchLabel.onclick = () => {
      searchTerm = '';
      searchInput.value = '';
      updateSearchLabel();
      renderGallery();
    };

    function startUploadFromFile(file){
      if(!file) return;
      if(!file.type || !file.type.startsWith('image/')){
        alert('Only images');
        return;
      }

      const imgObj = new Image();
      const reader = new FileReader();

      reader.onload = ev => {
        imgObj.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx    = canvas.getContext('2d');
          const max    = 1600;
          let w = imgObj.width, h = imgObj.height;
          if(w > max || h > max){
            const s = Math.min(max/w, max/h);
            w *= s; h *= s;
          }
          canvas.width  = w;
          canvas.height = h;
          ctx.drawImage(imgObj, 0, 0, w, h);
          pendingImage = canvas.toDataURL('image/jpeg', 0.82);
          uploadPreview.src = pendingImage;

          uploadHint.style.display='none';
          uploadConfirmStep=0;
          pendingTags = [];
          tagInput.value = '';
          renderTagChips();

          uploadOverlay.style.display='flex';
        };
        imgObj.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    document.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.display='flex';
    });
    document.addEventListener('dragenter', e => {
      e.preventDefault();
      dropZone.style.display='flex';
    });
    document.addEventListener('dragleave', e => {
      if(e.target === document.body || e.target === dropZone){
        dropZone.style.display='none';
      }
    });
    document.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.display='none';
      const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if(file) startUploadFromFile(file);
    });

    // Upload zu Supabase + Tabelle
    async function uploadImageToSupabase(dataUrl, tags){
      try{
        const blob = dataURLToBlob(dataUrl);
        const fileExt = 'jpg';
        const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${fileExt}`;
        const filePath = `uploads/${fileName}`;

        const { data, error } = await supabaseClient
          .storage
          .from(SUPABASE_BUCKET)
          .upload(filePath, blob, {
            contentType: 'image/jpeg',
            cacheControl: '3600'
          });

        if(error){
          console.error('Supabase upload error:', error);
          alert('upload failed');
          return null;
        }

        const { data: publicData } = supabaseClient
          .storage
          .from(SUPABASE_BUCKET)
          .getPublicUrl(filePath);

        const publicUrl = publicData && publicData.publicUrl;
        if(!publicUrl){
          alert('could not get public url');
          return null;
        }

        const { data: inserted, error: insertError } = await supabaseClient
          .from(SUPABASE_TABLE)
          .insert({ url: publicUrl, tags })
          .select()
          .single();

        if(insertError){
          console.error('Supabase insert error:', insertError);
          alert('saving metadata failed');
          return null;
        }

        return {
          id: inserted.id,
          src: inserted.url,
          tags: inserted.tags || [],
          pullers: [],
          reportBy: [],
          reportHidden: false
        };
      }catch(err){
        console.error('Supabase upload exception:', err);
        alert('upload failed (exception)');
        return null;
      }
    }

    uploadPush.onclick = async () => {
      if(!pendingImage) return;

      if(uploadConfirmStep === 0){
        uploadHint.style.display='block';
        uploadConfirmStep=1;
        return;
      }

      const tags = pendingTags.slice(0,7);

      const imgObj = await uploadImageToSupabase(pendingImage, tags);
      if(!imgObj){
        return;
      }

      images.unshift(imgObj);
      pendingImage = null;
      pendingTags = [];
      tagInput.value = '';
      renderTagChips();
      uploadOverlay.style.display='none';
      uploadConfirmStep=0;
      uploadHint.style.display='none';

      area='public';
      viewOwner=null;
      ownerMenuOpen = false;
      setGridUIVisible(true);
      renderGallery();
      const first = gallery.querySelector('img');
      if(first) first.scrollIntoView({ behavior: 'auto', block: 'start' });
    };

    uploadCancel.onclick = () => {
      pendingImage=null;
      pendingTags = [];
      tagInput.value = '';
      renderTagChips();
      uploadOverlay.style.display='none';
      uploadConfirmStep=0;
      uploadHint.style.display='none';
    };

    window.addEventListener('scroll', () => {
      if(singleScrollView.style.display === 'block') return;
      if(uploadOverlay.style.display === 'flex') return;
      const y = window.scrollY || 0;
      if(viewOwner){
        scrollState.walls[viewOwner] = y;
      } else if(area === 'public'){
        scrollState.public = y;
      } else if(area === 'private'){
        scrollState.private = y;
      }
    });

    let landingHintShown = false;

    function showLanding(fromShortcut){
      if(!landingOverlay) return;
      landingOverlay.style.display = 'flex';
      landingOverlay.classList.remove('hidden');
      if(landingMessage){
        if(fromShortcut){
          landingHintShown = true;
          landingMessage.style.opacity = 1;
        } else {
          landingHintShown = false;
          landingMessage.style.opacity = 0;
        }
      }
    }

    document.addEventListener('keydown', e => {
      const ae = document.activeElement;
      const isTyping = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA');

      if(!isTyping){
        if(e.key === 'y' || e.key === 'Y'){
          let v = Number(columnsRange.value);
          const min = Number(columnsRange.min);
          if(v > min){
            columnsRange.value = String(v - 1);
            updateColumns();
          }
          return;
        }

        if(e.key === 'x' || e.key === 'X'){
          let v = Number(columnsRange.value);
          const max = Number(columnsRange.max);
          if(v < max){
            columnsRange.value = String(v + 1);
            updateColumns();
          }
          return;
        }

        if(e.key === 'z' || e.key === 'Z'){
          const baseList = getCurrentList();
          const q = (searchTerm || '').toLowerCase();
          let list;
          if(isAdmin() && (q === 'reported' || q === 'hidden')){
            list = baseList;
          } else {
            list = baseList.filter(matchesSearch);
          }
          if(list.length > 0){
            const idx = Math.floor(Math.random() * list.length);
            blinkWord(logo);
            openSingle(idx, list);
          }
          return;
        }

        if(e.key === 'p' || e.key === 'P'){
          if(singleScrollView.style.display === 'block' && currentSingleList && currentSingleIndex != null){
            const btns = singleScrollView.querySelectorAll('.actionBtn');
            const btn  = btns[currentSingleIndex];
            if(btn) btn.click();
          }
          return;
        }

        if(e.key === 'i' || e.key === 'I'){
          showLanding(true);
          return;
        }
      }

      if(e.key === 'Escape'){
        if(uploadOverlay.style.display === 'flex'){
          pendingImage=null;
          pendingTags = [];
          tagInput.value = '';
          renderTagChips();
          uploadOverlay.style.display='none';
          uploadConfirmStep=0;
          uploadHint.style.display='none';
        } else if(singleScrollView.style.display === 'block'){
          closeScroll(null);
        } else if(contactOverlay.style.display === 'flex'){
          contactOverlay.style.display='none';
        } else if(authOverlay.style.display === 'flex'){
          authOverlay.style.display='none';
          authName.value='';
          authKey.value='';
          if(authResolve){
            authResolve(false);
            authResolve = null;
          }
        }
      } else if(singleScrollView.style.display === 'block'){
        if(e.key === 'ArrowRight'){
          e.preventDefault();
          if(currentSingleList && currentSingleIndex != null){
            const newIndex = currentSingleIndex + 1;
            if(newIndex >= 0 && newIndex < currentSingleList.length){
              currentSingleIndex = newIndex;
              const target = singleScrollView.children[newIndex];
              if(target) target.scrollIntoView({ behavior:'smooth', block:'center' });
            }
          }
        } else if(e.key === 'ArrowLeft'){
          e.preventDefault();
          if(currentSingleList && currentSingleIndex != null){
            const newIndex = currentSingleIndex - 1;
            if(newIndex >= 0 && newIndex < currentSingleList.length){
              currentSingleIndex = newIndex;
              const target = singleScrollView.children[newIndex];
              if(target) target.scrollIntoView({ behavior:'smooth', block:'center' });
            }
          }
        }
      }
    });

    (function initLanding(){
      if(!landingOverlay || !landingLogo || !landingMessage) return;
      const ack = sessionStorage.getItem('push_landing_ack') === '1';

      landingLogo.addEventListener('click', () => {
        if(!landingHintShown){
          landingHintShown = true;
          landingMessage.style.opacity = 1;
        } else {
          sessionStorage.setItem('push_landing_ack','1');
          landingOverlay.classList.add('hidden');
          landingOverlay.addEventListener('transitionend', function handler(){
            landingOverlay.removeEventListener('transitionend', handler);
            landingOverlay.style.display = 'none';
          });
        }
      });

      if(landingContact){
        landingContact.addEventListener('click', (e)=>{
          e.stopPropagation();
          contactOverlay.style.display = 'flex';
        });
      }

      if(!ack){
        showLanding(false);
      } else {
        landingOverlay.style.display = 'none';
        landingOverlay.classList.remove('hidden');
        landingMessage.style.opacity = 0;
      }
    })();

    if(contactClose){
      contactClose.addEventListener('click', ()=>{
        contactOverlay.style.display = 'none';
      });
    }
    contactOverlay.addEventListener('click', (e)=>{
      if(e.target === contactOverlay){
        contactOverlay.style.display = 'none';
      }
    });

    // AUTH-Funktionen
    function openAuthOverlay(){
      authOverlay.style.display = 'flex';
      authName.focus();
    }
    function closeAuthOverlay(){
      authOverlay.style.display = 'none';
      authName.value = '';
      authKey.value = '';
    }

    async function handleAuthSubmit(){
      if(authInProgress) return;
      const name = (authName.value || '').trim();
      const key = authKey.value || '';
      if(!name || !key) return;

      authInProgress = true;
      const email = name.toLowerCase() + '@push.local';
      try{
        let { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password: key
        });
        if(error){
          const msg = (error.message || '').toLowerCase();
          if(msg.includes('invalid login credentials')){
            const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
              email,
              password: key,
              options: {
                data: { username: name }
              }
            });
            if(signUpError){
              console.error('signUp error', signUpError);
              alert('login failed');
              authInProgress = false;
              return;
            }
            data = signUpData;
          } else {
            console.error('signIn error', error);
            alert('login failed');
            authInProgress = false;
            return;
          }
        }
        const user = data.user;
        authUser = user;
        const uname = user.user_metadata && user.user_metadata.username
          ? user.user_metadata.username
          : name;
        if(!wallPullsByUser[uname]){
          wallPullsByUser[uname] = wallPullsByUser[uname] || [];
          saveWallPulls();
        }
        currentUser = {
          username: uname,
          userId: user.id,
          wallPulls: wallPullsByUser[uname] || []
        };
        saveCurrentUser();
        await loadPullsForCurrentUser();
        renderGallery();
        updateProfile();
        closeAuthOverlay();
        if(authResolve){
          authResolve(true);
          authResolve = null;
        }
      }catch(err){
        console.error('auth exception', err);
        alert('login failed');
        if(authResolve){
          authResolve(false);
          authResolve = null;
        }
      }finally{
        authInProgress = false;
      }
    }

    async function ensureAuth(){
      if(authUser && currentUser) return true;
      // Versuche Session aus Supabase zu holen
      try{
        const { data, error } = await supabaseClient.auth.getUser();
        if(!error && data && data.user){
          authUser = data.user;
          const uname = data.user.user_metadata && data.user.user_metadata.username
            ? data.user.user_metadata.username
            : 'user';
          if(!wallPullsByUser[uname]){
            wallPullsByUser[uname] = wallPullsByUser[uname] || [];
            saveWallPulls();
          }
          currentUser = {
            username: uname,
            userId: data.user.id,
            wallPulls: wallPullsByUser[uname] || []
          };
          saveCurrentUser();
          await loadPullsForCurrentUser();
          renderGallery();
          updateProfile();
          return true;
        }
      }catch(e){
        console.error('ensureAuth getUser error', e);
      }
      return new Promise(resolve=>{
        authResolve = resolve;
        openAuthOverlay();
      });
    }

    authEnter.addEventListener('click', handleAuthSubmit);
    authKey.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        handleAuthSubmit();
      }
    });
    authName.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        authKey.focus();
      }
    });
    authCancel.addEventListener('click', ()=>{
      closeAuthOverlay();
      if(authResolve){
        authResolve(false);
        authResolve = null;
      }
    });

    // Bilder aus Supabase laden (globaler Feed)
    async function loadImagesFromSupabase(){
  try{
    const { data, error } = await supabaseClient
      .from(SUPABASE_TABLE)
      .select('*')
      .order('created_at', { ascending: false });

    if(error){
      console.error('Supabase load error:', error);
      return;
    }
    if(!data || data.length === 0){
      return; // Demo-Fallback bleibt
    }

    images = data.map(row => ({
      id: row.id,
      src: row.url,
      tags: row.tags || [],
      pullers: row.pullers || [],   // <— WICHTIG: aus DB holen
      reportBy: [],
      reportHidden: false
    }));
  }catch(err){
    console.error('Supabase load exception:', err);
  }
}


    // Pulls des aktuellen Users laden
  async function loadPullsForCurrentUser(){
  saved = [];
  if(!authUser || !currentUser) return;
  try{
    // Pulls inkl. created_at holen und nach neuestem Pull sortieren
    const { data: pullRows, error } = await supabaseClient
      .from(SUPABASE_PULLS_TABLE)
      .select('image_id, created_at')
      .eq('user_id', authUser.id)
      .order('created_at', { ascending: false });

    if(error){
      console.error('load pulls error:', error);
      return;
    }
    if(!pullRows || pullRows.length === 0) return;

    const ids = pullRows.map(r => r.image_id);

    const { data: imgRows, error: imgError } = await supabaseClient
      .from(SUPABASE_TABLE)
      .select('*')
      .in('id', ids);

    if(imgError){
      console.error('load pulls images error:', imgError);
      return;
    }

    const byId = new Map(imgRows.map(row => [row.id, row]));

    // saved in der Reihenfolge der Pull-Zeit (neueste zuerst)
    saved = pullRows
      .map(pr => {
        const row = byId.get(pr.image_id);
        if(!row) return null;
        return {
          src: row.url,
          imageId: row.id,
          pulledAt: pr.created_at || null
        };
      })
      .filter(Boolean);

    // eigenen User sowohl lokal als auch in der DB in pullers eintragen
    if(currentUser && images && Array.isArray(images)){
      const bySrc = new Map(images.map(img => [img.src, img]));
      const updates = [];

      saved.forEach(s => {
        const base = bySrc.get(s.src);
        if(base && base.id){
          let arr = Array.isArray(base.pullers) ? base.pullers.slice() : [];
          if(!arr.includes(currentUser.username)){
            arr.push(currentUser.username);
            base.pullers = arr; // lokal aktualisieren
            updates.push({ id: base.id, pullers: arr }); // später in DB schreiben
          }
        }
      });

      // Änderungen in die images-Tabelle zurückschreiben
      for(const u of updates){
        try{
          const { error: updError } = await supabaseClient
            .from(SUPABASE_TABLE)
            .update({ pullers: u.pullers })
            .eq('id', u.id);
          if(updError){
            console.error('loadPullsForCurrentUser update pullers error:', updError);
          }
        }catch(e){
          console.error('loadPullsForCurrentUser update pullers exception:', e);
        }
      }
    }
  }catch(err){
    console.error('loadPullsForCurrentUser exception:', err);
  }
}




    // Pull setzen/entfernen
   async function setPullForImage(base, shouldPull){
  if(!authUser || !currentUser || !base || !base.id) return;

  // 1) pulls-Tabelle für private Wall pflegen
  if(shouldPull){
    try{
      const { error } = await supabaseClient
        .from(SUPABASE_PULLS_TABLE)
        .insert({
          user_id: authUser.id,
          image_id: base.id
        });
      if(error){
        const msg = (error.message || '').toLowerCase();
        if(msg.includes('duplicate')){
          // schon vorhanden → egal
        } else {
          console.error('insert pull error:', error);
        }
      }
    }catch(err){
      console.error('insert pull exception:', err);
    }
  } else {
    try{
      const { error } = await supabaseClient
        .from(SUPABASE_PULLS_TABLE)
        .delete()
        .eq('user_id', authUser.id)
        .eq('image_id', base.id);
      if(error){
        console.error('delete pull error:', error);
      }
    }catch(err){
      console.error('delete pull exception:', err);
    }
  }

  // 2) lokale saved-Liste + pullers-Array aktualisieren
  if(shouldPull){
    if(!isSaved(base.src)){
      saved.unshift({
        src: base.src,
        imageId: base.id,
        pulledAt: Date.now()
      });
    }
    if(currentUser){
      if(!base.pullers) base.pullers = [];
      if(!base.pullers.includes(currentUser.username)){
        base.pullers.push(currentUser.username);
      }
    }
  } else {
    saved = saved.filter(s => s.src !== base.src);
    if(currentUser && base.pullers){
      base.pullers = base.pullers.filter(u => u !== currentUser.username);
    }
  }

  // 3) pullers auch in der images-Tabelle speichern
  try{
    const { error: updError } = await supabaseClient
      .from(SUPABASE_TABLE)
      .update({ pullers: base.pullers || [] })
      .eq('id', base.id);
    if(updError){
      console.error('update pullers error:', updError);
    }
  }catch(err){
    console.error('update pullers exception:', err);
  }
}


    async function initAuth(){
      try{
        const { data, error } = await supabaseClient.auth.getUser();
        if(!error && data && data.user){
          authUser = data.user;
          const uname = data.user.user_metadata && data.user.user_metadata.username
            ? data.user.user_metadata.username
            : 'user';
          if(!wallPullsByUser[uname]){
            wallPullsByUser[uname] = wallPullsByUser[uname] || [];
            saveWallPulls();
          }
          currentUser = {
            username: uname,
            userId: data.user.id,
            wallPulls: wallPullsByUser[uname] || []
          };
        }
      }catch(e){
        console.error('initAuth error', e);
      }
    }

    async function initApp(){
      await initAuth();
      await loadImagesFromSupabase();
      await loadPullsForCurrentUser();
      renderGallery();
      updateProfile();
      updateSearchLabel();
      setGridUIVisible(true);
    }

    initApp();
  </script>
</body>
</html>
