<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>push — Gallery</title>
  <style>
    :root{
      --gap:4px;
      --topbar:60px;
    }
    body{
      margin:0;
      background:#fff;
      font-family:Helvetica,Arial,sans-serif;
      overflow-x:hidden;
      color:#222;
    }

    /* TOP BAR */
    #topBar{
      position:fixed;
      top:0;left:0;right:0;
      height:var(--topbar);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      box-sizing:border-box;
      z-index:100;
      background:#ffffffcc;
      backdrop-filter:blur(6px);
      border-bottom:1px solid #eee;
    }
    #logo{
      font-size:20px;
      cursor:pointer;
    }

    /* zentrierte Blöcke zwischen push & pull */
    #leftCenter,
    #rightCenter{
      display:flex;
      align-items:center;
    }
    #leftCenter{
      margin-left:32px;
    }
    #rightCenter{
      margin-right:32px;
    }

    /* Suche: nur Wort "search" */
    #searchInput{
      margin-left:0;
      padding:0;
      border:none;
      background:transparent;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      outline:none;
      width:90px;
      color:#222;
      cursor:text;
    }
    #searchInput::placeholder{
      color:#555;
      opacity:1;
    }
    #searchLabel{
      margin-left:8px;
      font-size:11px;
      color:#999;
      font-family:Helvetica,Arial,sans-serif;
      cursor:pointer;
      display:none;
    }

    #profileBtn{
      cursor:pointer;
      font-size:20px;
      color:#222;
      font-weight:400;
      font-family:Helvetica,Arial,sans-serif;
    }

    /* Slider: nur Linie, ohne Griff */
    #columnsRange{
      width:120px;
      appearance:none;
      background:transparent;
      height:14px;
      border-radius:2px;
      cursor:pointer;
    }
    #columnsRange:focus{ outline:none; }
    #columnsRange::-webkit-slider-runnable-track{
      height:14px;
      background:transparent;
      border-radius:2px;
    }
    #columnsRange::-moz-range-track{
      height:14px;
      background:transparent;
      border-radius:2px;
    }
    #columnsRange::-webkit-slider-thumb{
      appearance:none;
      width:0;
      height:0;
      border:none;
      background:transparent;
      margin-top:0;
    }
    #columnsRange::-moz-range-thumb{
      width:0;
      height:0;
      border:none;
      background:transparent;
    }

    /* gallery grid */
    #gallery{
      margin-top:calc(var(--topbar) + 10px);
      display:grid;
      gap:var(--gap);
      padding:var(--gap);
      box-sizing:border-box;
    }
    .thumb{
      width:100%;
      display:block;
      cursor:pointer;
      object-fit:cover;
    }

    /* Hero: halb breit, rechtsbündig für Pull-Walls */
    .heroWrap{
      grid-column:1 / -1;
      display:flex;
      justify-content:flex-end;
    }
    .heroThumb{
      width:50%;
      max-width:50%;
      display:block;
      object-fit:cover;
    }

    /* Empty state */
    .emptyState{
      grid-column:1 / -1;
      padding:40px 0 80px;
      text-align:center;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      color:#aaa;
    }

    /* Username-/Wall-Bar */
    #leaveBar{
      display:none;
      grid-column:1 / -1;
      padding:50px 18px;
      background:#fff;
      box-sizing:border-box;
    }
    #leaveMainRow{
      display:flex;
      align-items:center;
      gap:32px;
      flex-wrap:wrap;
    }
    #leaveOwner{
      font-family:Helvetica,Arial,sans-serif;
      font-size:20px;
      color:#222;
      cursor:pointer;
    }
    #leaveInfluences{
      display:flex;
      align-items:center;
      gap:24px;
      margin-left:16px;
      flex-wrap:wrap;
    }
    #leaveInfluences span{
      font-family:Helvetica,Arial,sans-serif;
      font-size:20px;
      color:#bbb;
      cursor:pointer;
    }
    #leaveInfluences span:hover{
      color:#444;
    }
    #leaveLogout{
      margin-top:20px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      text-align:right;
      color:#444;
      cursor:pointer;
      display:none;
    }

    /* single scroll view */
    #singleScrollView{
      position:fixed;
      inset:0;
      background:#fff;
      overflow-y:scroll;
      display:none;
      z-index:80;
      padding-top:var(--topbar);
      opacity:0;
      transition:opacity 0.12s ease-out;
    }
    .singleItem{
      height:calc(100vh - var(--topbar));
      display:flex;
      align-items:center;
      justify-content:center;
      padding-top:24px;
      padding-bottom:120px;
      box-sizing:border-box;
      position:relative;
      flex-direction:column;
    }
    .singleItem img{
      max-height:calc(100vh - var(--topbar) - 24px - 120px);
      max-width:90vw;
      object-fit:contain;
      cursor:pointer;
    }
    .singleItem img.hiddenAdmin{
      outline:1px solid #f3cccc;
    }
    .actionBtn{
      position:absolute;
      right:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      cursor:pointer;
      color:#555;
    }

    /* report */
    .reportBtn{
      position:absolute;
      left:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      cursor:pointer;
      color:#aaa;
    }
    .reportBtn.reported{
      color:#c33;
    }
    .restoreBtn{
      position:absolute;
      left:5vw;
      bottom:62px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:12px;
      cursor:pointer;
      color:#777;
    }

    /* Hover-Zone links (puller) */
    .hoverLeft{
      position:absolute;
      top:0;
      bottom:80px;
      left:5vw;
      width:12vw;
      cursor:default;
    }
    .singleUsers{
      position:absolute;
      left:5vw;
      top:50%;
      transform:translateY(-50%);
      font-family:Helvetica,Arial,sans-serif;
      font-size:13px;
      color:#bbb;
      max-width:12vw;
      max-height:60vh;
      line-height:1.4;
      text-align:right; /* rechtsbündig */
      white-space:pre-line;
      display:none;
      overflow-y:auto;
    }
    .singleUsers div{
      cursor:pointer;
    }
    .singleUsers div:hover{
      color:#888;
    }
    .hoverLeft:hover + .singleUsers{
      display:block;
    }
    /* vertikale Linie zwischen Usern und Bild */
    .singleUsers::before{
      content:'';
      position:absolute;
      right:-18px;
      top:10%;
      bottom:10%;
      width:1px;
      background:#ddd;
    }

    /* Hover-Zone rechts (keine Credits mehr) */
    .hoverRight{
      position:absolute;
      top:0;
      bottom:0;
      right:5vw;
      width:12vw;
      cursor:default;
    }

    /* upload overlay */
    #uploadOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:#fff;
      z-index:200;
      flex-direction:column;
    }
    #uploadPreview{
      max-width:50vw;
      max-height:50vh;
      object-fit:contain;
      margin-bottom:18px;
    }
    .uploadMeta{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
      color:#444;
      align-items:flex-start;
    }
    .uploadMeta input{
      border:none;
      border-bottom:1px solid #ddd;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      padding:2px 0;
      outline:none;
      width:260px;
      background:transparent;
    }

    /* Tag-Chips */
    #metaTags{
      border:none;
      border-bottom:1px solid #ddd;
      font-family:Helvetica,Arial,sans-serif;
      font-size:14px;
      padding:2px 0;
      outline:none;
      width:260px;
      background:transparent;
    }
    #tagChips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      max-width:260px;
    }
    .tagChip{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #ddd;
      color:#444;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .tagChip:hover{
      border-color:#aaa;
    }

    #uploadHint{
      position:absolute;
      right:5vw;
      bottom:72px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:11px;
      color:#999;
      max-width:260px;
      line-height:1.4;
      display:none;
      text-align:right;
    }
    #uploadPush{
      position:absolute;
      right:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      color:#444;
      cursor:pointer;
    }
    #uploadCancel{
      position:absolute;
      left:5vw;
      bottom:40px;
      font-family:Helvetica,Arial,sans-serif;
      font-size:16px;
      color:#444;
      cursor:pointer;
    }

    .hideRange #columnsRange{display:none}

    /* Drag & Drop Overlay */
    #dropZone{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      border:4px dashed #bbb;
      background:rgba(0,0,0,0.04);
      z-index:190;
      font-size:22px;
      color:#666;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="topBar">
    <div id="logo">push</div>

    <div id="leftCenter">
      <input id="searchInput" type="text" placeholder="search" />
      <span id="searchLabel"></span>
    </div>

    <div id="rightCenter">
      <input id="columnsRange" type="range" min="2" max="7" value="5" />
    </div>

    <div id="profileBtn">pull</div>
  </div>

  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div id="dropZone">drop image here</div>

  <div id="gallery"></div>

  <div id="leaveBar">
    <div id="leaveMainRow">
      <span id="leaveOwner"></span>
      <span id="leaveInfluences"></span>
    </div>
    <div id="leaveLogout">logout</div>
  </div>

  <div id="singleScrollView"></div>

  <div id="uploadOverlay">
    <img id="uploadPreview" alt="preview" />
    <div class="uploadMeta">
      <!-- nur Tags, keine Titel/Name -->
      <input id="metaTags" type="text" placeholder="tag" />
      <div id="tagChips"></div>
    </div>
    <div id="uploadHint">
      I understand the image will be published forever and cannot be deleted.<br/>
      I own the rights of this image.
    </div>
    <div id="uploadPush">push</div>
    <div id="uploadCancel">✕</div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /***********************
     * Supabase Setup
     ***********************/
    const SUPABASE_URL = 'https://wsftiujnfywdxmzrvgqv.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzZnRpdWpuZnl3ZHhtenJ2Z3F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NTg0ODksImV4cCI6MjA3OTQzNDQ4OX0.h8NxTr-3MrdBN7mFxFPVweux1FduI9qI58UyPCxRcmE';  
    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const REPORT_THRESHOLD = 5;

    /***********************
     * State
     ***********************/
    let images = [
      // Demo-Bilder (ohne Titel/Name, nur Tags), werden von Supabase-Daten überschrieben
      {
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#111'/><circle cx='400' cy='300' r='160' fill='#444'/><text x='50%' y='50%' fill='#fafafa' font-size='36' font-family='Helvetica' text-anchor='middle' dy='12'>luna 01</text></svg>",
        title: "",
        name: "",
        tags: ["luna","demo","dark"],
        pullers: ["luna"],
        reportBy: [],
        reportHidden: false
      },
      {
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#f5f5f5'/><rect x='80' y='60' width='640' height='480' fill='#ddd'/><text x='50%' y='50%' fill='#444' font-size='32' font-family='Helvetica' text-anchor='middle' dy='10'>ghost 01</text></svg>",
        title: "",
        name: "",
        tags: ["ghost","demo","gray"],
        pullers: ["ghost"],
        reportBy: [],
        reportHidden: false
      },
      {
        src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#002b36'/><rect x='120' y='120' width='560' height='360' fill='#268bd2'/><text x='50%' y='50%' fill='#fdf6e3' font-size='30' font-family='Helvetica' text-anchor='middle' dy='10'>luna & ghost</text></svg>",
        title: "",
        name: "",
        tags: ["luna","ghost","demo"],
        pullers: ["luna","ghost"],
        reportBy: [],
        reportHidden: false
      }
    ];

    let saved  = [];
    let pendingImage = null;
    let area = 'public';   // 'public' | 'private'
    let viewOwner = null;  // null oder username, wenn auf fremder Wall
    let uploadConfirmStep = 0;
    let searchTerm = '';

    let currentSingleList = null;
    let currentSingleIndex = null;

    let currentUser = null;
    let ownerMenuOpen = false; // eigener Name unten: menu open/close

    const scrollState = {
      public: 0,
      private: 0,
      walls: {}
    };

    // Map: username -> array von usernames, die er als Wall gepullt hat
    let wallPullsByUser = {};
    try{
      wallPullsByUser = JSON.parse(localStorage.getItem('push_wall_pulls') || '{}');
    }catch(e){
      wallPullsByUser = {};
    }
    function saveWallPulls(){
      try{
        localStorage.setItem('push_wall_pulls', JSON.stringify(wallPullsByUser));
      }catch(e){}
    }

    try{
      saved = JSON.parse(localStorage.getItem('push_saved') || '[]');
    }catch(e){
      saved = [];
    }
    try{
      const u = localStorage.getItem('push_user');
      if(u) currentUser = JSON.parse(u);
    }catch(e){
      currentUser = null;
    }
    if(currentUser){
      if(!wallPullsByUser[currentUser.username]){
        wallPullsByUser[currentUser.username] = currentUser.wallPulls && Array.isArray(currentUser.wallPulls)
          ? currentUser.wallPulls
          : [];
        saveWallPulls();
      }
      currentUser.wallPulls = wallPullsByUser[currentUser.username];
    }

    /***********************
     * DOM
     ***********************/
    const gallery           = document.getElementById('gallery');
    const singleScrollView  = document.getElementById('singleScrollView');
    const columnsRange      = document.getElementById('columnsRange');
    const profileBtn        = document.getElementById('profileBtn');
    const logo              = document.getElementById('logo');
    const uploadOverlay     = document.getElementById('uploadOverlay');
    const uploadPreview     = document.getElementById('uploadPreview');
    const uploadPush        = document.getElementById('uploadPush');
    const uploadCancel      = document.getElementById('uploadCancel');
    const fileInput         = document.getElementById('fileInput');
    const searchInput       = document.getElementById('searchInput');
    const searchLabel       = document.getElementById('searchLabel');
    const leaveBar          = document.getElementById('leaveBar');
    const leaveOwner        = document.getElementById('leaveOwner');
    const leaveInfluences   = document.getElementById('leaveInfluences');
    const leaveLogout       = document.getElementById('leaveLogout');
    const dropZone          = document.getElementById('dropZone');

    const metaTags          = document.getElementById('metaTags');
    const tagChips          = document.getElementById('tagChips');
    const uploadHint        = document.getElementById('uploadHint');

    const isSaved = src => saved.some(s => s.src === src);

    function isAdmin(){
      return currentUser && currentUser.username === 'push-admin';
    }

    function saveCurrentUser(){
      if(!currentUser) return;
      try{
        localStorage.setItem('push_user', JSON.stringify(currentUser));
      }catch(e){}
    }

    /***********************
     * Tag-Chip-Logik
     ***********************/
    let currentUploadTags = [];

    function renderTagChips(){
      tagChips.innerHTML = '';
      currentUploadTags.forEach(tag => {
        const chip = document.createElement('span');
        chip.className = 'tagChip';
        chip.textContent = tag;
        chip.onclick = () => {
          currentUploadTags = currentUploadTags.filter(t => t !== tag);
          renderTagChips();
        };
        tagChips.appendChild(chip);
      });
    }

    function tryAddTagFromInput(){
      let raw = metaTags.value.trim().toLowerCase();
      if(!raw) return;

      const parts = raw.split(',').map(p => p.trim()).filter(Boolean);
      for(const part of parts){
        if(currentUploadTags.length >= 7) break;
        if(part.length === 0) continue;
        if(part.length > 21) continue;
        if(!/^[a-z0-9]+$/.test(part)) continue;
        if(!currentUploadTags.includes(part)){
          currentUploadTags.push(part);
        }
      }
      metaTags.value = '';
      renderTagChips();
    }

    function collectTagValues(){
      return currentUploadTags.slice();
    }

    function resetTagInputUI(){
      currentUploadTags = [];
      metaTags.value = '';
      renderTagChips();
    }

    metaTags.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ','){
        e.preventDefault();
        tryAddTagFromInput();
      } else if(e.key === 'Backspace' && !metaTags.value){
        currentUploadTags.pop();
        renderTagChips();
      }
    });
    metaTags.addEventListener('blur', () => {
      tryAddTagFromInput();
    });

    /***********************
     * Search & Matches
     ***********************/
    function matchesSearch(img){
      if(!searchTerm) return true;

      const raw = searchTerm.trim();

      // TAG-SUCHE: wenn mit '#' beginnt → nur Tags
      if(raw.startsWith('#')){
        const q = raw.slice(1).toLowerCase().trim();
        if(!q) return true;
        const tagsArr = img.tags || [];
        return tagsArr.some(t => (t || '').toLowerCase().includes(q));
      }

      // normale Suche (Titel/Name leer, aber Tags & Puller bleiben)
      const q        = raw.toLowerCase();
      const title    = (img.title || '').toLowerCase();
      const name     = (img.name  || '').toLowerCase();
      const tagsStr  = (img.tags  || []).join(' ').toLowerCase();
      const pullers  = (img.pullers || []).join(' ').toLowerCase();

      return (
        title.includes(q)   ||
        name.includes(q)    ||
        tagsStr.includes(q) ||
        pullers.includes(q)
      );
    }

    function findUserByQuery(qRaw){
      const q = (qRaw || '').trim().toLowerCase();
      if(!q) return null;

      const found = new Set();

      images.forEach(img => {
        (img.pullers || []).forEach(u => {
          if(u && u.toLowerCase() === q){
            found.add(u);
          }
        });
      });

      Object.keys(wallPullsByUser || {}).forEach(owner=>{
        if(owner && owner.toLowerCase() === q){
          found.add(owner);
        }
      });

      if(currentUser && currentUser.username &&
        currentUser.username.toLowerCase() === q){
        found.add(currentUser.username);
      }

      if(found.size === 0) return null;
      return [...found][0];
    }

    function getAllWallOwners(){
      const set = new Set();

      images.forEach(img => {
        (img.pullers || []).forEach(u => {
          if(u) set.add(u);
        });
      });

      Object.keys(wallPullsByUser || {}).forEach(owner=>{
        if(owner) set.add(owner);
        (wallPullsByUser[owner] || []).forEach(u=>{
          if(u) set.add(u);
        });
      });

      if(currentUser && currentUser.username){
        set.add(currentUser.username);
      }
      if(viewOwner){
        set.add(viewOwner);
      }

      return [...set];
    }

    /***********************
     * Reporting
     ***********************/
    function isHiddenGlobal(img){
      if(isAdmin()) return false;
      const base = images.find(i => i.src === img.src);
      return !!(base && base.reportHidden);
    }

    function updateHiddenFlag(base){
      const count = (base.reportBy || []).length;
      base.reportHidden = count >= REPORT_THRESHOLD;
    }

    /***********************
     * Layout / Slider
     ***********************/
    function updateColumns(){
      const v = Number(columnsRange.value);
      const cols = 9 - v; // 2→7, 7→2
      gallery.style.gridTemplateColumns = `repeat(${cols},1fr)`;

      const min = Number(columnsRange.min);
      const max = Number(columnsRange.max);
      const ratio = (v - min) / (max - min || 1);
      const pct = ratio * 100;

      const grad = `linear-gradient(to right,#555 0%,#555 ${pct}%,#ddd ${pct}%,#ddd 100%)`;
      columnsRange.style.background = grad;
      columnsRange.style.backgroundSize = '100% 2px';
      columnsRange.style.backgroundPosition = 'center';
      columnsRange.style.backgroundRepeat = 'no-repeat';
    }
    columnsRange.addEventListener('input', updateColumns);
    updateColumns();

    function blinkWord(el){
      el.style.opacity = '0';
      setTimeout(() => {
        el.style.opacity = '1';
      }, 120);
    }

    function updateSearchLabel(){
      if(searchTerm){
        searchLabel.style.display = 'inline';
        searchLabel.textContent = '✕';
      } else {
        searchLabel.style.display = 'none';
        searchLabel.textContent = '';
      }
    }

    function setGridUIVisible(on){
      if(on){
        columnsRange.style.display = 'block';
        searchInput.style.display  = 'inline';
        updateSearchLabel();
      }else{
        columnsRange.style.display = 'none';
        searchInput.style.display  = 'none';
        searchLabel.style.display  = 'none';
      }
    }

    /***********************
     * User / Auth
     ***********************/
    function ensureUser(){
      if(currentUser) return true;
      const name = prompt('username');
      if(!name) return false;
      const uname = name.trim();
      if(!uname) return false;
      currentUser = { username: uname, wallPulls: [] };
      if(!wallPullsByUser[uname]){
        wallPullsByUser[uname] = [];
        saveWallPulls();
      }
      currentUser.wallPulls = wallPullsByUser[uname];
      saveCurrentUser();
      return true;
    }

    function getCurrentList(){
      const q = (searchTerm || '').toLowerCase();

      if(isAdmin() && q){
        if(q === 'reported'){
          return images.filter(img => (img.reportBy || []).length > 0);
        }
        if(q === 'hidden'){
          return images.filter(img => img.reportHidden);
        }
      }

      if(!viewOwner && area === 'private'){
        const res = [];
        for(const s of saved){
          const base = images.find(img => img.src === s.src);
          if(base && !isHiddenGlobal(base)){
            res.push(base);
          }
        }
        return res;
      }

      let base;
      if(viewOwner){
        base = images.filter(img => img.pullers && img.pullers.includes(viewOwner));
      } else {
        base = images;
      }
      return base.filter(img => !isHiddenGlobal(img));
    }

    /***********************
     * Gallery Render
     ***********************/
    function renderGallery(){
      gallery.innerHTML = '';
      leaveInfluences.innerHTML = '';

      const baseList = getCurrentList();
      const q = (searchTerm || '').toLowerCase();
      let list;
      if(isAdmin() && (q === 'reported' || q === 'hidden')){
        list = baseList;
      } else {
        list = baseList.filter(matchesSearch);
      }

      const isOwnPullGallery      = (!viewOwner && area === 'private' && currentUser);
      const isForeignPullGallery  = !!viewOwner;
      const isPullGallery         = isOwnPullGallery || isForeignPullGallery;

      // PUBLIC / ADMIN VIEW
      if(!isPullGallery){
        ownerMenuOpen = false;
        leaveBar.style.display = 'none';
        leaveLogout.style.display = 'none';
        leaveInfluences.style.display = 'none';

        if(list.length === 0){
          const msg = document.createElement('div');
          msg.className = 'emptyState';
          msg.textContent = 'no images';
          gallery.appendChild(msg);
          return;
        }

        list.forEach((img, i) => {
          const el = document.createElement('img');
          el.src = img.src;
          el.className = 'thumb';
          el.onclick = () => openSingle(i, list);
          gallery.appendChild(el);
        });
        return;
      }

      // PULL-GALERIEN (eigene oder fremde Wall)
      leaveBar.style.display = 'block';

      if(isOwnPullGallery){
        // eigene Pull-Wall
        leaveOwner.textContent = currentUser.username;

        const ownPulls = wallPullsByUser[currentUser.username] || [];
        ownPulls.forEach(un => {
          const s = document.createElement('span');
          s.textContent = un;
          s.onclick = ev => {
            ev.stopPropagation();
            openUserWall(un);
          };
          leaveInfluences.appendChild(s);
        });

        if(ownerMenuOpen){
          leaveInfluences.style.display = 'none';
          leaveLogout.style.display = 'block';
        } else {
          leaveLogout.style.display = 'none';
        }

        leaveOwner.onclick = ev => {
          ev.stopPropagation();
          ownerMenuOpen = !ownerMenuOpen;
          renderGallery();
        };

      } else {
        // fremde Wall
        ownerMenuOpen = false;

        leaveOwner.textContent = viewOwner;
        leaveLogout.style.display = 'none';

        const foreignPulls = wallPullsByUser[viewOwner] || [];
        foreignPulls.forEach(un => {
          const s = document.createElement('span');
          s.textContent = un;
          s.onclick = ev => {
            ev.stopPropagation();
            openUserWall(un);
          };
          leaveInfluences.appendChild(s);
        });

        leaveOwner.onclick = ev => {
          ev.stopPropagation();
          if(!ensureUser()) return;
          const uName = viewOwner;
          if(!wallPullsByUser[currentUser.username]){
            wallPullsByUser[currentUser.username] = [];
          }
          const pulls = wallPullsByUser[currentUser.username];
          const idx = pulls.indexOf(uName);
          let flash = '';

          if(idx === -1){
            if(pulls.length >= 7){
              pulls.shift();
            }
            pulls.push(uName);
            flash = 'pull';
          } else {
            pulls.splice(idx,1);
            flash = 'push';
          }
          currentUser.wallPulls = pulls;
          saveCurrentUser();
          saveWallPulls();

          const original = leaveOwner.textContent;
          leaveOwner.textContent = flash;
          setTimeout(() => {
            leaveOwner.textContent = original;
          }, 220);
        };
      }

      // "push" als Username am Ende der Reihe (random Wall)
      const allOwners = getAllWallOwners();
      if(allOwners.length){
        const pushSpan = document.createElement('span');
        pushSpan.textContent = 'push';
        pushSpan.onclick = (e) => {
          e.stopPropagation();

          let candidates = allOwners;

          if(viewOwner){
            candidates = allOwners.filter(u => u !== viewOwner);
            if(!candidates.length) candidates = allOwners;
          } else if(currentUser && isOwnPullGallery){
            candidates = allOwners.filter(u => u !== currentUser.username);
            if(!candidates.length) candidates = allOwners;
          }

          const idx = Math.floor(Math.random()*candidates.length);
          const target = candidates[idx];
          if(target){
            blinkWord(pushSpan);
            openUserWall(target);
          }
        };
        leaveInfluences.appendChild(pushSpan);
      }

      if(ownerMenuOpen){
        leaveInfluences.style.display = 'none';
      } else {
        leaveInfluences.style.display =
          leaveInfluences.children.length ? 'flex' : 'none';
      }

      if(list.length === 0){
        const msg = document.createElement('div');
        msg.className = 'emptyState';
        msg.textContent = isOwnPullGallery ? 'no pulls yet' : 'no images';
        gallery.appendChild(msg);
        gallery.appendChild(leaveBar);
        return;
      }

      // Hero halb breit, rechts
      const heroWrap = document.createElement('div');
      heroWrap.className = 'heroWrap';

      const heroImg = document.createElement('img');
      heroImg.src = list[0].src;
      heroImg.className = 'thumb heroThumb';
      heroImg.onclick = () => openSingle(0, list);

      heroWrap.appendChild(heroImg);
      gallery.appendChild(heroWrap);

      // Username-/Influence-Balken
      gallery.appendChild(leaveBar);

      // Restliche Bilder
      for(let i = 1; i < list.length; i++){
        const el = document.createElement('img');
        el.src = list[i].src;
        el.className = 'thumb';
        el.onclick = () => openSingle(i, list);
        gallery.appendChild(el);
      }
    }

    function closeScroll(src){
      singleScrollView.style.display = 'none';
      singleScrollView.style.opacity = 0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      if(src){
        const t = [...gallery.querySelectorAll('img')].find(x => x.src === src);
        if(t) t.scrollIntoView({ behavior: 'auto', block: 'nearest' });
      }
      currentSingleList = null;
      currentSingleIndex = null;
    }

    function openUserWall(username){
      viewOwner = username;
      area = 'public';
      singleScrollView.style.display = 'none';
      singleScrollView.style.opacity = 0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      const y = scrollState.walls[username] || 0;
      window.scrollTo({ top: y, behavior: 'auto' });
    }

    function openSingle(startIndex, listOverride=null){
      setGridUIVisible(false);

      const fullList = getCurrentList();
      const q = (searchTerm || '').toLowerCase();
      const list = listOverride || (
        (isAdmin() && (q === 'reported' || q === 'hidden'))
          ? fullList
          : fullList.filter(matchesSearch)
      );
      singleScrollView.innerHTML='';

      currentSingleList = list;
      currentSingleIndex = startIndex;

      const effectiveArea = viewOwner ? 'public' : area;
      const reporterId = (currentUser && currentUser.username) || '__anon__';

      function updateActions(){
        singleScrollView.querySelectorAll('.actionBtn').forEach((btn,i)=>{
          const item=list[i]; if(!item) return;
          btn.textContent = (effectiveArea==='public')
            ? (isSaved(item.src) ? 'push' : 'pull')
            : 'push';
        });
      }

      list.forEach((img,idx)=>{
        const wrap=document.createElement('div');
        wrap.className='singleItem';

        const base = images.find(i => i.src === img.src) || img;
        if(!base.reportBy) base.reportBy = [];

        const im=document.createElement('img');
        im.src=img.src;
        if(isAdmin() && base.reportHidden){
          im.classList.add('hiddenAdmin');
        }
        im.onclick=()=>closeScroll(img.src);
        wrap.appendChild(im);

        const rep = document.createElement('div');
        rep.className = 'reportBtn';
        rep.textContent = 'report';
        if(base.reportBy.includes(reporterId)) rep.classList.add('reported');
        rep.onclick = e => {
          e.stopPropagation();
          if(!base.reportBy) base.reportBy = [];
          const already = base.reportBy.includes(reporterId);
          if(!already){
            base.reportBy.push(reporterId);
          } else {
            base.reportBy = base.reportBy.filter(id => id !== reporterId);
          }
          updateHiddenFlag(base);
          const nowReported = base.reportBy.includes(reporterId);
          rep.classList.toggle('reported', nowReported);
          rep.textContent = nowReported ? 'reported' : 'undo';
          setTimeout(() => { rep.textContent = 'report'; }, 800);
          renderGallery();
        };
        wrap.appendChild(rep);

        if(isAdmin() && base.reportBy.length > 0){
          const restore = document.createElement('div');
          restore.className = 'restoreBtn';
          restore.textContent = base.reportHidden ? 'restore · hidden' : 'restore';
          restore.onclick = e => {
            e.stopPropagation();
            base.reportBy = [];
            base.reportHidden = false;
            rep.classList.remove('reported');
            rep.textContent = 'report';
            renderGallery();
          };
          wrap.appendChild(restore);
        }

        const hoverLeft = document.createElement('div');
        hoverLeft.className = 'hoverLeft';
        wrap.appendChild(hoverLeft);

        const usersDiv = document.createElement('div');
        usersDiv.className = 'singleUsers';
        function renderUsersList(){
          usersDiv.innerHTML = '';
          if(base.pullers && base.pullers.length){
            base.pullers.forEach(name=>{
              const line = document.createElement('div');
              line.textContent = name;
              line.onclick = ev => {
                ev.stopPropagation();
                openUserWall(name);
              };
              usersDiv.appendChild(line);
            });
          }
        }
        renderUsersList();
        wrap.appendChild(usersDiv);

        const hoverRight = document.createElement('div');
        hoverRight.className = 'hoverRight';
        wrap.appendChild(hoverRight);

        // keine Credits mehr auf der rechten Seite

        const act=document.createElement('div');
        act.className='actionBtn';
        act.textContent = (effectiveArea==='public')
          ? (isSaved(img.src) ? 'push' : 'pull')
          : 'push';
        act.onclick=e=>{
          e.stopPropagation();
          if(effectiveArea==='public'){
            if(!isSaved(base.src)){
              if(!ensureUser()) return;
            }
            if(isSaved(base.src)){
              saved = saved.filter(s => s.src !== base.src);
              if(base.pullers && currentUser){
                base.pullers = base.pullers.filter(u => u !== currentUser.username);
              }
            } else {
              if(!base.pullers) base.pullers = [];
              if(currentUser && !base.pullers.includes(currentUser.username)){
                base.pullers.push(currentUser.username);
              }
              saved.unshift({
                src: base.src,
                pulledAt: Date.now()
              });
            }
            try{
              localStorage.setItem('push_saved', JSON.stringify(saved));
            }catch(e){}
            updateActions();
            renderUsersList();
          } else {
            const iSaved = saved.findIndex(s=>s.src===base.src);
            if(iSaved!==-1){
              const removed = saved.splice(iSaved,1)[0];
              try{
                localStorage.setItem('push_saved', JSON.stringify(saved));
              }catch(e){}
              if(currentUser){
                const pub = images.find(x=>x.src===removed.src);
                if(pub && pub.pullers){
                  pub.pullers = pub.pullers.filter(u => u !== currentUser.username);
                }
              }
              if(saved.length===0){
                closeScroll(null);
              } else {
                openSingle(Math.min(iSaved,saved.length-1));
              }
            }
          }
        };
        wrap.appendChild(act);

        singleScrollView.appendChild(wrap);
      });

      singleScrollView.style.display='block';
      requestAnimationFrame(()=>{
        singleScrollView.style.opacity = 1;
      });
      document.body.classList.add('hideRange');
      const target = singleScrollView.children[startIndex];
      if (target) target.scrollIntoView({ behavior: 'auto', block: 'center' });
    }

    function updateProfile(){
      profileBtn.textContent = 'pull';
    }

    profileBtn.onclick = () => {
      blinkWord(profileBtn);
      if(!ensureUser()) return;
      area = 'private';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      const y = scrollState.private || 0;
      window.scrollTo({ top: y, behavior: 'auto' });
    };

    function doLogout(){
      if(!currentUser) return;
      currentUser = null;
      try{
        localStorage.removeItem('push_user');
        localStorage.removeItem('push_saved');
      }catch(e){}
      saved = [];
      area = 'public';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      updateProfile();
      window.scrollTo({ top: 0, behavior: 'auto' });
    }

    leaveLogout.onclick = () => {
      if(confirm('logout?')){
        doLogout();
        leaveLogout.style.display = 'none';
      }
    };

    logo.onclick = () => {
      blinkWord(logo);
      area = 'public';
      viewOwner = null;
      ownerMenuOpen = false;
      singleScrollView.style.display='none';
      singleScrollView.style.opacity=0;
      document.body.classList.remove('hideRange');
      setGridUIVisible(true);
      renderGallery();
      scrollState.public = 0;
      window.scrollTo({ top: 0, behavior:'auto' });
    };

    searchInput.addEventListener('input', e => {
      searchTerm = e.target.value.trim();
      updateSearchLabel();
      renderGallery();
    });

    searchInput.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        const raw = searchInput.value.trim();
        if(!raw) return;
        if(raw.startsWith('#')) return;

        const userName = findUserByQuery(raw);
        if(userName){
          searchTerm = '';
          searchInput.value = '';
          updateSearchLabel();
          openUserWall(userName);
          e.preventDefault();
        }
      }
    });

    searchLabel.onclick = () => {
      searchTerm = '';
      searchInput.value = '';
      updateSearchLabel();
      renderGallery();
    };

    /***********************
     * Upload-Helfer
     ***********************/
    function dataURLToBlob(dataUrl){
      const arr = dataUrl.split(',');
      const mimeMatch = arr[0].match(/:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/jpeg';
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--){
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    function startUploadFromFile(file){
      if(!file) return;
      if(!file.type || !file.type.startsWith('image/')){
        alert('Only images');
        return;
      }

      const imgObj = new Image();
      const reader = new FileReader();

      reader.onload = ev => {
        imgObj.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx    = canvas.getContext('2d');
          const max    = 1600;
          let w = imgObj.width, h = imgObj.height;
          if(w > max || h > max){
            const s = Math.min(max/w, max/h);
            w *= s; h *= s;
          }
          canvas.width  = w;
          canvas.height = h;
          ctx.drawImage(imgObj, 0, 0, w, h);
          pendingImage = canvas.toDataURL('image/jpeg', 0.82);

          // Dateigrößenlimit (5 MB) nach Kompression
          const blob = dataURLToBlob(pendingImage);
          const MAX_SIZE = 5 * 1024 * 1024; // 5 MB
          if(blob.size > MAX_SIZE){
            alert('image too big (max 5MB)');
            pendingImage = null;
            return;
          }

          uploadPreview.src = pendingImage;

          uploadHint.style.display='none';
          uploadConfirmStep=0;
          resetTagInputUI();

          uploadOverlay.style.display='flex';
        };
        imgObj.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Drag & Drop
    document.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.display='flex';
    });
    document.addEventListener('dragenter', e => {
      e.preventDefault();
      dropZone.style.display='flex';
    });
    document.addEventListener('dragleave', e => {
      if(e.target === document.body || e.target === dropZone){
        dropZone.style.display='none';
      }
    });
    document.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.display='none';
      const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if(file) startUploadFromFile(file);
    });

    // Upload Push
    uploadPush.onclick = async () => {
      if(!pendingImage) return;

      if(uploadConfirmStep === 0){
        uploadHint.style.display='block';
        uploadConfirmStep=1;
        return;
      }

      const tags = collectTagValues();
      const blob = dataURLToBlob(pendingImage);

      const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;

      try{
        // 1) in Storage hochladen
        const { data: uploadData, error: uploadError } = await supa
          .storage
          .from('images')
          .upload(fileName, blob, {
            contentType:'image/jpeg',
            upsert:false
          });

        if(uploadError){
          console.error('upload error', uploadError);
          alert('upload failed');
          return;
        }

        // 2) Public URL holen
        const { data: urlData } = supa
          .storage
          .from('images')
          .getPublicUrl(uploadData.path);

        const imageUrl = urlData.publicUrl;

        // 3) Zeile in Tabelle images anlegen
        const { data: inserted, error: insertError } = await supa
          .from('images')
          .insert({
            image_url: imageUrl,
            tags: tags
          })
          .select()
          .single();

        if(insertError){
          console.error('insert error', insertError);
          alert('save failed');
          return;
        }

        // 4) Lokalen State updaten
        const newImg = {
          src: imageUrl,
          title: "",
          name: "",
          tags: inserted.tags || [],
          pullers: [],
          reportBy: inserted.report_by || [],
          reportHidden: !!inserted.report_hidden
        };

        images.unshift(newImg);

        // UI zurücksetzen
        pendingImage = null;
        uploadOverlay.style.display='none';
        uploadConfirmStep=0;
        uploadHint.style.display='none';
        resetTagInputUI();

        area='public';
        viewOwner=null;
        ownerMenuOpen = false;
        setGridUIVisible(true);
        renderGallery();
        const first = gallery.querySelector('img');
        if(first) first.scrollIntoView({ behavior: 'auto', block: 'start' });

      }catch(err){
        console.error('unexpected upload error', err);
        alert('error');
      }
    };

    uploadCancel.onclick = () => {
      pendingImage=null;
      uploadOverlay.style.display='none';
      uploadConfirmStep=0;
      uploadHint.style.display='none';
      resetTagInputUI();
    };

    // Scroll-Positions-Merker
    window.addEventListener('scroll', () => {
      if(singleScrollView.style.display === 'block') return;
      if(uploadOverlay.style.display === 'flex') return;
      const y = window.scrollY || 0;
      if(viewOwner){
        scrollState.walls[viewOwner] = y;
      } else if(area === 'public'){
        scrollState.public = y;
      } else if(area === 'private'){
        scrollState.private = y;
      }
    });

    // Keyboard Shortcuts (x,y,z,p,ESC, Pfeile)
    document.addEventListener('keydown', e => {
      const ae = document.activeElement;
      const isTyping = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA');

      if(!isTyping){
        // y = kleinere Kacheln (mehr Spalten)
        if(e.key === 'y' || e.key === 'Y'){
          let v = Number(columnsRange.value);
          const min = Number(columnsRange.min);
          if(v > min){
            columnsRange.value = String(v - 1);
            updateColumns();
          }
          return;
        }

        // x = größere Kacheln (weniger Spalten)
        if(e.key === 'x' || e.key === 'X'){
          let v = Number(columnsRange.value);
          const max = Number(columnsRange.max);
          if(v < max){
            columnsRange.value = String(v + 1);
            updateColumns();
          }
          return;
        }

        // z = random Bild in Einzelansicht
        if(e.key === 'z' || e.key === 'Z'){
          const baseList = getCurrentList();
          const q = (searchTerm || '').toLowerCase();
          let list;
          if(isAdmin() && (q === 'reported' || q === 'hidden')){
            list = baseList;
          } else {
            list = baseList.filter(matchesSearch);
          }
          if(list.length > 0){
            const idx = Math.floor(Math.random() * list.length);
            blinkWord(logo);
            openSingle(idx, list);
          }
          return;
        }

        // p = pull/push in Einzelansicht
        if(e.key === 'p' || e.key === 'P'){
          if(singleScrollView.style.display === 'block' && currentSingleList && currentSingleIndex != null){
            const btns = singleScrollView.querySelectorAll('.actionBtn');
            const btn  = btns[currentSingleIndex];
            if(btn) btn.click();
          }
          return;
        }
      }

      if(e.key === 'Escape'){
        if(uploadOverlay.style.display === 'flex'){
          pendingImage=null;
          uploadOverlay.style.display='none';
          uploadConfirmStep=0;
          uploadHint.style.display='none';
        } else if(singleScrollView.style.display === 'block'){
          closeScroll(null);
        }
      } else if(singleScrollView.style.display === 'block'){
        if(e.key === 'ArrowRight'){
          e.preventDefault();
          if(currentSingleList && currentSingleIndex != null){
            const newIndex = currentSingleIndex + 1;
            if(newIndex >= 0 && newIndex < currentSingleList.length){
              currentSingleIndex = newIndex;
              const target = singleScrollView.children[newIndex];
              if(target) target.scrollIntoView({ behavior:'smooth', block:'center' });
            }
          }
        } else if(e.key === 'ArrowLeft'){
          e.preventDefault();
          if(currentSingleList && currentSingleIndex != null){
            const newIndex = currentSingleIndex - 1;
            if(newIndex >= 0 && newIndex < currentSingleList.length){
              currentSingleIndex = newIndex;
              const target = singleScrollView.children[newIndex];
              if(target) target.scrollIntoView({ behavior:'smooth', block:'center' });
            }
          }
        }
      }
    });

    /***********************
     * Supabase: Bilder laden
     ***********************/
    async function loadImagesFromSupabase(){
      try{
        const { data, error } = await supa
          .from('images')
          .select('*')
          .order('created_at', { ascending:false });

        if(error){
          console.error('supabase select error', error);
          renderGallery(); // fallback auf Demo
          return;
        }

        images = (data || []).map(row => ({
          src: row.image_url,
          title: "",
          name: "",
          tags: row.tags || [],
          pullers: [],
          reportBy: row.report_by || [],
          reportHidden: !!row.report_hidden
        }));

        renderGallery();
      }catch(err){
        console.error('supabase init error', err);
        renderGallery(); // fallback
      }
    }

    /***********************
     * Init
     ***********************/
    updateProfile();
    updateSearchLabel();
    setGridUIVisible(true);
    renderTagChips();
    loadImagesFromSupabase(); // ersetzt Demo-Bilder, wenn DB da ist
  </script>
</body>
</html>
